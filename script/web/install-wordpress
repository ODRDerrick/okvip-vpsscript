#!/bin/bash

# Ki·ªÉm tra quy·ªÅn root
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui l√≤ng ch·∫°y v·ªõi quy·ªÅn root."
  exit 1
fi

# ƒê·ªçc th√¥ng tin ƒë·∫ßu v√†o
MYSQL_ROOT_PASSWORD=$1
DOMAIN=$2
TEMPLATE_URL=$3
USERNAME=$4
DB_PASSWORD=${5:-$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)}
ADMIN_USERNAME=$6
ADMIN_PASS=$7

WEB_ROOT="/var/www/$DOMAIN"
DB_NAME="${DOMAIN//./_}" # T√™n c∆° s·ªü d·ªØ li·ªáu, thay th·∫ø d·∫•u ch·∫•m b·∫±ng d·∫•u g·∫°ch d∆∞·ªõi
DB_USER=${USERNAME:-$DB_NAME"_user"}

# Ki·ªÉm tra n·∫øu kh√¥ng nh·∫≠p c√°c th√¥ng tin c·∫ßn thi·∫øt th√¨ b√°o l·ªói
if [ -z "$TEMPLATE_URL" ] || [ -z "$ADMIN_USERNAME" ] || [ -z "$ADMIN_PASS" ]; then
  echo "Error: Vui l√≤ng nh·∫≠p URL c·ªßa template."
  echo "S·ª≠ d·ª•ng: <mysql_root_password> <domain> <template_url> <username> <password> <admin_username> <admin_pass>"
  exit 1
fi

# Ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng
if ! [[ "$TEMPLATE_URL" =~ ^https:// ]]; then
  echo "Error: Template URL kh√¥ng h·ª£p l·ªá. URL ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng https://"
  exit 1
fi

# Ki·ªÉm tra c√°c th√¥ng tin ƒë·∫ßu v√†o
if [ -z "$MYSQL_ROOT_PASSWORD" ] || [ -z "$DOMAIN" ]; then
  echo "Error: S·ª≠ d·ª•ng: <mysql_root_password> <domain> <template_url> <username> <password> <admin_username> <admin_pass>"
  exit 1
fi

# Ki·ªÉm tra Nginx, MySQL v√† PHP
if ! command -v nginx >/dev/null; then
  echo "Error: Nginx ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t. Vui l√≤ng kh·ªüi t·∫°o server tr∆∞·ªõc."
  exit 1
fi
if ! command -v mysql >/dev/null; then
  echo "Error: MySQL ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t. Vui l√≤ng kh·ªüi t·∫°o server tr∆∞·ªõc."
  exit 1
fi
if ! command -v php >/dev/null; then
  echo "Error: PHP ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t. Vui l√≤ng kh·ªüi t·∫°o server tr∆∞·ªõc."
  exit 1
fi

# Ki·ªÉm tra v√† c√†i ƒë·∫∑t WP-CLI n·∫øu ch∆∞a c√≥
if ! command -v wp >/dev/null; then
  echo "C√†i ƒë·∫∑t WP-CLI..."
  curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
  chmod +x wp-cli.phar
  mv wp-cli.phar /usr/local/bin/wp
  if ! command -v wp >/dev/null; then
    echo "Error: Kh√¥ng th·ªÉ c√†i ƒë·∫∑t WP-CLI. D·ª´ng l·∫°i."
    exit 1
  fi
fi

# Ki·ªÉm tra m·∫≠t kh·∫©u MySQL
if ! mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "exit" >/dev/null 2>&1; then
  echo "Error: M·∫≠t kh·∫©u MySQL kh√¥ng ch√≠nh x√°c. D·ª´ng l·∫°i."
  exit 1
fi

echo "B·∫Øt ƒë·∫ßu c√†i ƒë·∫∑t WordPress v·ªõi domain $DOMAIN v√† template t·ª´ $TEMPLATE_URL..."

# C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt
if ! command -v unzip >/dev/null; then
  apt install unzip -y
fi
if ! command -v certbot >/dev/null; then
  apt install certbot python3-certbot-nginx -y
fi

# T·∫°o database v√† user MySQL
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
USER_EXISTS=$(mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -sse "SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '$DB_USER');")
if [ "$USER_EXISTS" -eq 1 ]; then
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "ALTER USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
else
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
fi
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "FLUSH PRIVILEGES;"

# T·∫£i v√† gi·∫£i n√©n template
mkdir -p $WEB_ROOT
wget -O /tmp/template.zip "$TEMPLATE_URL" --no-check-certificate --quiet
if [ $? -ne 0 ]; then
  echo "Error: Kh√¥ng th·ªÉ t·∫£i template t·ª´ URL $TEMPLATE_URL. D·ª´ng l·∫°i."
  exit 1
fi
unzip -o /tmp/template.zip -d $WEB_ROOT

# Import database n·∫øu c√≥ file db.sql
if [ -f "$WEB_ROOT/db.sql" ]; then
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" $DB_NAME < $WEB_ROOT/db.sql
  # Update option_value
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" $DB_NAME -e "UPDATE wp_options SET option_value = 'https://$DOMAIN' WHERE option_name IN ('siteurl', 'home');"
  # X√≥a file db.sql sau khi import
  rm -f "$WEB_ROOT/db.sql"
  echo "File db.sql ƒë√£ ƒë∆∞·ª£c x√≥a sau khi c√†i ƒë·∫∑t th√†nh c√¥ng."
else
  echo "Error: Kh√¥ng t√¨m th·∫•y file db.sql trong template. D·ª´ng l·∫°i."
  exit 1
fi


# C·∫•u h√¨nh Nginx
cat > /etc/nginx/sites-available/$DOMAIN <<EOL
server {
    listen 80;
    server_name $DOMAIN;
    root $WEB_ROOT;

    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }

    error_log /var/log/nginx/$DOMAIN-error.log;
    access_log /var/log/nginx/$DOMAIN-access.log;
}
EOL
ln -s /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx

# C√†i ƒë·∫∑t SSL
if ! certbot certificates | grep -q "$DOMAIN"; then
  echo "========================================"
  echo "üîπ Ki·ªÉm tra SSL cho domain: $DOMAIN"
  echo "üîπ Ch∆∞a t√¨m th·∫•y ch·ª©ng ch·ªâ SSL, ti·∫øn h√†nh c√†i ƒë·∫∑t..."
  echo "========================================"

  certbot_output=$(certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m "no-reply@$DOMAIN" --redirect 2>&1)

  if [[ $? -eq 0 ]]; then
    echo "C√†i ƒë·∫∑t SSL th√†nh c√¥ng cho $DOMAIN!"
  else
    echo "C√†i ƒë·∫∑t SSL th·∫•t b·∫°i cho $DOMAIN!"
    echo "L·ªói chi ti·∫øt:"
    echo "$certbot_output"
  fi
else
  echo "SSL ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t cho $DOMAIN."
fi

# C·∫•u h√¨nh wp-config.php
if [ ! -f "$WEB_ROOT/wp-config.php" ]; then
  wp config create --dbname="$DB_NAME" --dbuser="$DB_USER" --dbpass="$DB_PASSWORD" --dbhost="localhost" --path=$WEB_ROOT --allow-root
fi
wp config set DB_NAME "$DB_NAME" --path=$WEB_ROOT --allow-root
wp config set DB_USER "$DB_USER" --path=$WEB_ROOT --allow-root
wp config set DB_PASSWORD "$DB_PASSWORD" --path=$WEB_ROOT --allow-root

# C·∫≠p nh·∫≠t m·∫≠t kh·∫©u admin tr·ª±c ti·∫øp trong database
ADMIN_PASS_MD5=$(echo -n "$ADMIN_PASS" | md5sum | awk '{print $1}')
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" $DB_NAME -e "UPDATE wp_users SET user_pass = '$ADMIN_PASS_MD5' WHERE user_login = '$ADMIN_USERNAME' OR user_login = 'admin';"

# Thi·∫øt l·∫≠p quy·ªÅn cho th∆∞ m·ª•c web
chown -R www-data:www-data $WEB_ROOT
chmod -R 755 $WEB_ROOT

# Ho√†n t·∫•t
echo "WordPress ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t th√†nh c√¥ng tr√™n domain https://$DOMAIN/"
echo "Th√¥ng tin c∆° s·ªü d·ªØ li·ªáu:"
echo "  - Database: $DB_NAME"
echo "  - User: $DB_USER"
echo "  - Password: $DB_PASSWORD"
echo "Th√¥ng tin t√†i kho·∫£n admin:"
echo "  - Username: $ADMIN_USERNAME"
echo "  - Password: $ADMIN_PASS"
