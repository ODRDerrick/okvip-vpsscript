#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui lòng chạy với quyền root."
  exit 1
fi

# Kiểm tra có ít nhất 1 domain được truyền vào
if [ "$#" -lt 1 ]; then
  echo "Cách dùng: $0 domain1.com domain2.com ..."
  exit 1
fi

BASE_PATH="/var/www"
LOG_DIR="/var/log/clamav-scans"
mkdir -p "$LOG_DIR"

# Cài ClamAV nếu chưa có
if ! command -v clamscan &>/dev/null; then
  echo "Chưa có ClamAV, đang cài đặt..."
  apt update && apt install -y clamav clamav-daemon
fi

# Lặp qua danh sách domain từ tham số
for DOMAIN in "$@"; do
  SITE_PATH="$BASE_PATH/$DOMAIN"
  LOG_FILE="$LOG_DIR/clamav-$DOMAIN.log"

  echo "Đang quét: $DOMAIN "
  if [ ! -d "$SITE_PATH" ]; then
    echo "Không tìm thấy thư mục $SITE_PATH, bỏ qua."
    continue
  fi

  clamscan -ri "$SITE_PATH" --log="$LOG_FILE"
  echo "Log lưu tại: $LOG_FILE"

  # Đếm số lượng file nhiễm
  FOUND=$(grep "Infected files:" "$LOG_FILE" | awk '{print $3}')
  if [ "$FOUND" -ne 0 ]; then
    echo "Phát hiện $FOUND file nhiễm mã độc trên $DOMAIN!"
  else
    echo "Không phát hiện mã độc."
  fi
done
